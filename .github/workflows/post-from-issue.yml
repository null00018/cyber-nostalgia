name: Create Blog Post from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write

jobs:
  post-generator:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Parse issue
        id: parse
        run: |
          title=$(echo "${{ github.event.issue.title }}" | sed 's/📬 //')
          body=$(echo "${{ github.event.issue.body }}")
          ymd=$(echo "$body" | grep "::date::" | sed 's/::date:://')
          content=$(echo "$body" | sed -n '/::content::/,$p' | sed '1d')
          filename="post$(date +%s).html"

          echo "title=$title" >> $GITHUB_OUTPUT
          echo "date=$ymd" >> $GITHUB_OUTPUT
          echo "body=$content" >> $GITHUB_OUTPUT
          echo "filename=$filename" >> $GITHUB_OUTPUT

      - name: Create post file
        run: |
          mkdir -p posts
          cat <<EOF > posts/${{ steps.parse.outputs.filename }}
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>${{ steps.parse.outputs.title }}</title>
  <link href="style.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <article>
      <h2 class="title">＞＞ ${{ steps.parse.outputs.title }}</h2>
      <p class="meta">${{ steps.parse.outputs.date }}</p>
      <div class="article-body">
        $(echo "${{ steps.parse.outputs.body }}" | sed ':a;N;$!ba;s/\n/<br>/g')
      </div>
    </article>
    <a href="index.html">←START</a>
  </div>
</body>
</html>
EOF

      - name: Update index.html
        run: |
          entry="<li><span class=\"title\"><a href=\"posts/${{ steps.parse.outputs.filename }}\" class=\"neon\">＞＞ ${{ steps.parse.outputs.title }}</a></span><span class=\"meta\">${{ steps.parse.outputs.date }}</span></li>"
          sed -i "s|<ul class=\"entry-list\">|<ul class=\"entry-list\">\n$entry|" index.html

      - name: Commit and Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add posts/${{ steps.parse.outputs.filename }} index.html
          git commit -m "Add post: ${{ steps.parse.outputs.filename }}"
          git push
